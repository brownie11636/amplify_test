(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5814],{4807:function(e,r,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/mediasoup/publish",function(){return n(2251)}])},2251:function(e,r,n){"use strict";n.r(r);var t=n(7568),c=n(4051),o=n.n(c),u=n(5893),s=n(7294),a=n(960),i=n(6809),l=n.n(i),d=n(6894);n(8584);r.default=function(e){var r,n=function(e){e.pause(),e.srcObject=null},c=function(e){var r=e.getTracks();r?r.forEach((function(e){return e.stop()})):console.warn("NO tracks")},i=function(){w.current&&(w.current.close(),w.current=null,g.current=null,console.log("socket.io closed.."))},f=function(e,r){return new Promise((function(n,t){w.current.emit(e,r,(function(e,r){e?t(e):n(r)}))}))},p=(0,s.useRef)(),h=(0,s.useRef)(),g=(0,s.useRef)(),k=(0,s.useRef)(),b=(0,s.useRef)(),x=(0,s.useRef)(),v=(0,s.useRef)(),w=(0,s.useRef)(),m=(0,s.useState)(!0),R=m[0],j=m[1],y=(0,s.useState)(!0),E=y[0],N=y[1],P=(0,s.useState)(!1),_=P[0],C=P[1],O=(0,s.useState)(!1),T=O[0],A=O[1];function S(){return S=(0,t.Z)(o().mark((function e(){var r,n,c,u,s,a,i,l,d,p;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(h.current){e.next=3;break}return console.warn("WARN: local media NOT READY"),e.abrupt("return");case 3:if(w.current){e.next=6;break}return e.next=6,Z().catch((function(e){console.error(e)}));case 6:return e.next=8,f("createRoom",{streamer:g.current});case 8:return r=e.sent,console.log("response msg from server >>",r),e.next=12,f("makeRouter",g.current);case 12:return n=e.sent,c=n.targetRouterrouter,u=n.allRouters,console.log("targetRouterrouter?",c),console.log("allRouters?",u),e.next=19,f("getRouterRtpCapabilities",g.current);case 19:return s=e.sent,console.log("getRouterRtpCapabilities:",s),e.next=23,D(s);case 23:return console.log("--- createProducerTransport --"),e.next=26,f("createProducerTransport",g.current);case 26:if(a=e.sent,console.log("transport params:",a),b.current=k.current.createSendTransport(a),console.log("createSendTransport:",b),b.current.on("connect",function(){var e=(0,t.Z)(o().mark((function e(r,n,t){var c;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:c=r.dtlsParameters,console.log("--trasnport connect"),f("connectProducerTransport",{dtlsParameters:c,socketid:g.current}).then(n).catch(t);case 3:case"end":return e.stop()}}),e)})));return function(r,n,t){return e.apply(this,arguments)}}()),b.current.on("produce",function(){var e=(0,t.Z)(o().mark((function e(r,n,t){var c,u,s;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c=r.kind,u=r.rtpParameters,console.log("--trasnport produce"),e.prev=2,e.next=5,f("produce",{socketid:g.current,transportId:b.current.id,kind:c,rtpParameters:u});case 5:s=e.sent.id,n({id:s}),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),t(e.t0);case 12:case"end":return e.stop()}}),e,null,[[2,9]])})));return function(r,n,t){return e.apply(this,arguments)}}()),b.current.on("connectionstatechange",(function(e){switch(e){case"connecting":console.log("publishing...");break;case"connected":console.log("published"),A(!0);break;case"failed":console.log("failed"),b.current.close()}})),!R){e.next=40;break}if(!(i=h.current.getVideoTracks()[0])){e.next=40;break}return l={track:i},e.next=39,b.current.produce(l);case 39:x.current=e.sent;case 40:if(!E){e.next=47;break}if(!(d=h.current.getAudioTracks()[0])){e.next=47;break}return p={track:d},e.next=46,b.current.produce(p);case 46:v.current=e.sent;case 47:case"end":return e.stop()}}),e)}))),S.apply(this,arguments)}(0,s.useEffect)((function(){Z()}),[]);var D=function(){var e=(0,t.Z)(o().mark((function e(r){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{k.current=new a.Device,console.log("device.current"),console.log(k.current)}catch(n){"UnsupportedError"===n.name&&console.error("browser not supported")}return console.log("device.current start"),console.log(k.current),console.log("device.current end"),e.next=6,k.current.load({routerRtpCapabilities:r});case 6:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),Z=function(){return w.current=l()(d.d5,{transports:["websocket"]}),new Promise((function(e,n){(r=w.current).on("connect",(function(e){console.log("socket.io connected()")})),r.on("error",(function(e){console.error("socket.io ERROR:",e),n(e)})),r.on("message",(function(n){console.log("socket.io message:",n),"welcome"===n.type?(r.id!==n.id&&console.warn("WARN: something wrong with clientID",r.io,n.id),g.current=n.id,console.log("connected to server. clientId="+g.current),e()):console.error("UNKNOWN message from server:",n)})),r.on("newProducer",function(){var e=(0,t.Z)(o().mark((function e(r){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.warn("IGNORE socket.io newProducer:",r);case 1:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}())}))};return(0,u.jsxs)("div",{children:[(0,u.jsxs)("div",{children:[(0,u.jsx)("input",{disabled:_,onChange:function(e){j(!R)},type:"checkbox",checked:R}),(0,u.jsx)("label",{children:"video"})]}),(0,u.jsxs)("div",{children:[(0,u.jsx)("input",{disabled:_,onChange:function(e){N(!E)},type:"checkbox",checked:E}),(0,u.jsx)("label",{children:"audio"})]}),(0,u.jsx)("button",{disabled:_,onClick:function(){h.current?console.warn("WARN: local media ALREADY started"):navigator.mediaDevices.getUserMedia({audio:E,video:R}).then((function(e){h.current=e,function(e,r){if(!e.srcObject)return e.srcObject=r,e.volume=0,e.play();console.warn("element ALREADY playing, so ignore")}(p.current,h.current),C(!0)})).catch((function(e){console.error("media ERROR:",e)}))},children:"Start Media"}),(0,u.jsx)("button",{disabled:!_||T,onClick:function(){h.current&&(n(p.current),c(h.current),h.current=null,C(!1))},children:"Stop Media"}),(0,u.jsx)("button",{disabled:T||!_,onClick:function(){return S.apply(this,arguments)},children:"publish"}),(0,u.jsx)("button",{disabled:!T||!_,onClick:function(){h.current&&(n(p.current),c(h.current),h.current=null),x.current&&(x.current.close(),x.current=null),v.current&&(v.current.close(),v.current=null),b.current&&(b.current.close(),b.current=null),i(),A(!1),C(!1)},children:"Disconnect"}),(0,u.jsxs)("div",{children:["local video",(0,u.jsx)("video",{ref:p,autoPlay:!0,style:{width:"240px",height:"180px",border:"1px solid black"}})]})]})}},6894:function(e,r,n){"use strict";n.d(r,{d5:function(){return t}});var t="https://43.201.110.62:3333"},7020:function(){}},function(e){e.O(0,[6809,7245,9774,2888,179],(function(){return r=4807,e(e.s=r);var r}));var r=e.O();_N_E=r}]);