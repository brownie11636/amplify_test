(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1469],{1958:function(e,n,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/mediasoup/subscribe",function(){return r(8865)}])},8865:function(e,n,r){"use strict";r.r(n);var t=r(7568),o=r(828),c=r(4051),u=r.n(c),s=r(5893),i=r(7294),a=r(960),l=r(6809),d=r.n(l),f=r(6894);n.default=function(e){var n=function(e,n){var r=p.current;if(r.srcObject)r.srcObject.addTrack(n);else{var t=new MediaStream;t.addTrack(n),function(e,n){if(!e.srcObject)return e.srcObject=n,e.volume=0,p.current=e,console.log("playVideo"),console.log(p),e.play();console.warn("element ALREADY playing, so ignore")}(r,t).then((function(){r.volume=1})).catch((function(e){console.error("media ERROR:",e)}))}},r=function(e,n){return new Promise((function(r,t){g.current.emit(e,n,(function(e,n){e?t(e):r(n)}))}))},c=function(){g.current&&(g.current.close(),g.current=null,m.current=null,console.log("socket.io closed.."))},l=function(){p.current&&(p.current.pause(),p.current.srcObject=null)},p=(0,i.useRef)(),m=((0,i.useRef)(),(0,i.useRef)()),v=(0,i.useRef)(),b=(0,i.useRef)(),h=(0,i.useRef)(),k=(0,i.useRef)(),g=(0,i.useRef)(),x=(0,i.useState)(""),y=x[0],w=x[1],R=(0,i.useRef)(),j=(0,i.useState)([]),O=j[0],C=j[1],Z=(0,i.useState)(!1),E=Z[0],S=Z[1],_=(0,i.useState)(!1);function A(){return A=(0,t.Z)(u().mark((function e(){var n,o,c;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=y,e.next=3,r("getRouterRtpCapabilities",n);case 3:return o=e.sent,console.log("getRouterRtpCapabilities:",o),e.next=7,T(o);case 7:return console.log("--- createConsumerTransport --"),e.next=10,r("createConsumerTransport",{socketid:n});case 10:return c=e.sent,console.log("transport params:",c),b.current=v.current.createRecvTransport(c),console.log("createConsumerTransport:",b),b.current.on("connect",function(){var e=(0,t.Z)(u().mark((function e(n,t,o){var c;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:c=n.dtlsParameters,console.log("--consumer trasnport connect"),r("connectConsumerTransport",{dtlsParameters:c}).then(t).catch(o);case 3:case"end":return e.stop()}}),e)})));return function(n,r,t){return e.apply(this,arguments)}}()),b.current.on("connectionstatechange",(function(e){switch(e){case"connecting":console.log("subscribing...");break;case"connected":console.log("subscribed"),S(!0);break;case"failed":console.log("failed"),b.current.close()}})),e.next=18,I(b.current,"video");case 18:return h.current=e.sent,e.next=21,I(b.current,"audio");case 21:k.current=e.sent;case 22:case"end":return e.stop()}}),e)}))),A.apply(this,arguments)}function I(e,n){return P.apply(this,arguments)}function P(){return(P=(0,t.Z)(u().mark((function e(n,t){var o;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,U(n,t);case 2:if(!(o=e.sent)){e.next=7;break}console.log("-- track exist, consumer ready. kind="+t),"video"===t?(console.log("-- resume kind="+t),r("resume",{kind:t}).then((function(){return console.log("resume OK"),o})).catch((function(e){return console.error("resume ERROR:",e),o}))):console.log("-- do not resume kind="+t),e.next=9;break;case 7:return console.log("-- no consumer yet. kind="+t),e.abrupt("return",null);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function T(e){return N.apply(this,arguments)}function N(){return(N=(0,t.Z)(u().mark((function e(n){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{v.current=new a.Device}catch(r){"UnsupportedError"===r.name&&console.error("browser not supported")}return e.next=3,v.current.load({routerRtpCapabilities:n});case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function U(e,n){return D.apply(this,arguments)}function D(){return(D=(0,t.Z)(u().mark((function e(t,o){var c,s,i,a,l,d,f,p,b;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("--start of consume --kind="+o),c=y,s=v.current.rtpCapabilities,e.next=5,r("consume",{rtpCapabilities:s,kind:o,socketid:c}).catch((function(e){console.error("consume ERROR:",e)}));case 5:if(i=e.sent,a=i.producerId,l=i.id,d=i.kind,f=i.rtpParameters,!a){e.next=17;break}return p={},e.next=11,t.consume({id:l,producerId:a,kind:d,rtpParameters:f,codecOptions:p});case 11:return b=e.sent,n(m.current,b.track),console.log("--end of consume"),e.abrupt("return",b);case 17:return console.warn("--- remote producer NOT READY"),e.abrupt("return",null);case 19:case"end":return e.stop()}}),e)})))).apply(this,arguments)}_[0],_[1],(0,i.useEffect)((function(){K()}),[]);var K=function(){return g.current=d()(f.d5,{transports:["websocket"]}),new Promise((function(e,n){var r=g.current;r.on("listUpdate",(function(e){!function(e){console.log("list Update..."),R.current=e;var n=O,r=!0,t=!1,c=void 0;try{for(var u,s=Object.entries(Object(R.current))[Symbol.iterator]();!(r=(u=s.next()).done);r=!0){var i=(0,o.Z)(u.value,2),a=i[0],l=i[1];n=n.concat("".concat(a,":").concat(l.socketid))}}catch(d){t=!0,c=d}finally{try{r||null==s.return||s.return()}finally{if(t)throw c}}C(n)}(e),console.log("listUpdate..")})),r.on("connect",(function(e){console.log("socket.io connected()")})),r.on("error",(function(e){console.error("socket.io ERROR:",e),n(e)})),r.on("message",(function(n){console.log("socket.io message:",n),"welcome"===n.type?(r.id!==n.id&&console.warn("WARN: something wrong with clientID",r.io,n.id),m.current=n.id,console.log("connected to server. clientId="+m.current),e()):console.error("UNKNOWN message from server:",n)})),r.on("newProducer",function(){var e=(0,t.Z)(u().mark((function e(n){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("socket.io newProducer:",n),!b.current){e.next=12;break}if("video"!==n.kind){e.next=8;break}return e.next=5,I(b.current,n.kind);case 5:h.current=e.sent,e.next=12;break;case 8:if("audio"!==n.kind){e.next=12;break}return e.next=11,I(b.current,n.kind);case 11:k.current=e.sent;case 12:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}()),r.on("producerClosed",(function(e){console.log("socket.io producerClosed:",e);var n,r=e.localId,t=e.remoteId,o=e.kind;console.log("--try removeConsumer remoteId="+t+", localId="+r+", kind="+o),"video"===o?h.current&&(h.current.close(),h.current=null):"audio"===o&&k.current&&(k.current.close(),k.current=null),t?(n=t,console.log(" ---- removeRemoteVideo() id="+n)):l()}))}))};return(0,s.jsxs)("div",{children:[(0,s.jsx)("button",{disabled:E,onClick:function(){return A.apply(this,arguments)},children:"Subscribe"}),(0,s.jsx)("button",{disabled:!E,onClick:function(){h.current&&(h.current.close(),h.current=null),k.current&&(k.current.close(),k.current=null),b.current&&(b.current.close(),b.current=null),l(),c(),S(!1)},children:"Disconnect"}),(0,s.jsxs)("div",{children:["remote video",(0,s.jsx)("br",{}),(0,s.jsx)("div",{children:(0,s.jsx)("video",{ref:p,autoPlay:!0,style:{width:"240px",height:"180px",border:"1px solid black"}})}),(0,s.jsxs)("select",{onChange:function(e){console.log("handleSelected? >>",e.target.value),w(e.target.value)},value:y,children:[(0,s.jsx)("option",{value:"null",children:"=== \uc2a4\ud2b8\ub9ac\uba38 \uc120\ud0dd ==="}),O.map((function(e){return(0,s.jsx)("option",{value:e.split(":")[1],children:e},e)}))]})]})]})}},6894:function(e,n,r){"use strict";r.d(n,{d5:function(){return t}});var t="https://43.201.110.62:3333"},7020:function(){},943:function(e,n,r){"use strict";function t(e,n){(null==n||n>e.length)&&(n=e.length);for(var r=0,t=new Array(n);r<n;r++)t[r]=e[r];return t}r.d(n,{Z:function(){return t}})},3375:function(e,n,r){"use strict";function t(e){if("undefined"!==typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}r.d(n,{Z:function(){return t}})},828:function(e,n,r){"use strict";r.d(n,{Z:function(){return c}});var t=r(3375);var o=r(1566);function c(e,n){return function(e){if(Array.isArray(e))return e}(e)||(0,t.Z)(e,n)||(0,o.Z)(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}},1566:function(e,n,r){"use strict";r.d(n,{Z:function(){return o}});var t=r(943);function o(e,n){if(e){if("string"===typeof e)return(0,t.Z)(e,n);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(r):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?(0,t.Z)(e,n):void 0}}}},function(e){e.O(0,[6809,7245,9774,2888,179],(function(){return n=1958,e(e.s=n);var n}));var n=e.O();_N_E=n}]);